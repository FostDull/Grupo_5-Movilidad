<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CÃ¡mara IP + GrabaciÃ³n</title>
</head>
<body>
  <h1>CÃ¡mara IP en Vivo</h1>

  <!-- Muestra el video al usuario -->
  <img id="ipCamDisplay" width="640" height="480" alt="CÃ¡mara IP" />

  <!-- Video oculto para grabar -->
  <video id="ipCam" autoplay muted playsinline hidden></video>

  <button id="recordBtn" onclick="startRecording()">Iniciar GrabaciÃ³n</button>
  <div id="status"></div>

  <script>
    const img = document.getElementById("ipCamDisplay");
    const video = document.getElementById("ipCam");
    const recordBtn = document.getElementById("recordBtn");
    const status = document.getElementById("status");

    const ipCamUrl = "http://192.168.100.249:8080/video"; // Cambia aquÃ­ si la IP es diferente
    img.src = ipCamUrl;
    video.src = ipCamUrl;

    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 640;
    canvas.height = 480;

    let mediaRecorder;
    let chunks = [];

    function startRecording() {
      function draw() {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        requestAnimationFrame(draw);
      }
      draw();

      const stream = canvas.captureStream(25);
      mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) chunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: "video/webm" });
        console.log("ðŸŽ¥ Blob size:", blob.size);

        if (blob.size === 0) {
          status.textContent = "âš ï¸ Video vacÃ­o, no se subiÃ³";
          recordBtn.textContent = "ðŸ”´ Grabando...";
          return;
        }

        const formData = new FormData();
        formData.append("file", blob, `video_${Date.now()}.webm`);

        status.textContent = "ðŸ“¤ Subiendo segmento...";
        recordBtn.textContent = "â³ Subiendo...";

        try {
          const res = await fetch("http://localhost:8000/upload-video/", {
            method: "POST",
            body: formData
          });
          const result = await res.json();
          status.textContent = "âœ… Subido: " + result.file_name;
          recordBtn.textContent = "ðŸ”´ Grabando...";
        } catch (err) {
          console.error(err);
          status.textContent = "âŒ Error al subir";
          recordBtn.textContent = "ðŸ”´ Grabando...";
        }

        chunks = [];
      };

      mediaRecorder.start();

      // Cada 25 segundos para el segmento
      setInterval(() => {
        if (mediaRecorder.state === "recording") {
          mediaRecorder.stop();
          mediaRecorder.start();
        }
      }, 25000);

      status.textContent = "ðŸŽ¥ Grabando video (25s por segmento)...";
      recordBtn.textContent = "ðŸ”´ Grabando...";
      recordBtn.disabled = true;
    }
  </script>
</body>
</html>
